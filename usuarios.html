<!DOCTYPE html>
<html lang="pt-br">
<head>

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Gerenciar Usuários</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link rel="stylesheet" href="css/styles.css"/>
</head>
<body>
  <nav class="navbar navbar-dark bg-dark mb-4">
    <div class="container-fluid">
      <span class="navbar-brand d-flex align-items-center">
        <img src="logo.png" alt="Logo" height="40" class="me-2" />
        Coletas KOERICH
      </span>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarLinks" aria-controls="navbarLinks" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarLinks">
        <ul class="navbar-nav me-auto mb-2 mb-lg-0" id="menu-links"></ul>
        <span class="navbar-text text-white me-3" id="user-info"></span>
      </div>
    </div>
  </nav>

  <div class="container">
    <h3>Cadastro de Usuários</h3>
    <form id="formUsuario" class="row g-3 mb-4">
      <div class="col-md-3">
        <label class="form-label">Usuário</label>
        <input type="text" class="form-control" name="usuario" required />
      </div>
      <div class="col-md-3">
        <label class="form-label">Senha</label>
        <input type="text" class="form-control" name="senha" required />
      </div>
      <div class="col-md-3">
        <label class="form-label">Tipo de Usuário</label>
        <select class="form-select" name="tipo" id="tipoUsuario" required>
          <option value="">Selecione</option>
          <option value="admin">Administrador</option>
          <option value="operador">Operador</option>
          <option value="transportadora">Transportadora</option>
        </select>
      </div>
      <div class="col-md-3 d-none" id="grupoTransportadora">
        <label class="form-label">Transportadora</label>
        <select class="form-select" name="transportadora" id="selectTransportadora">
          <option value="">Selecione</option>
        </select>
      </div>
      <div class="col-12">
        <button class="btn btn-primary" type="submit">Adicionar Usuário</button>
      </div>
    </form>

    <h3>Cadastro de Transportadoras</h3>
    <form id="formTransportadora" class="row g-3 mb-4">
      <div class="col-md-6">
        <label class="form-label">Nome da Transportadora</label>
        <input type="text" class="form-control" name="nomeTransportadora" required />
      </div>
      <div class="col-12">
        <button class="btn btn-success" type="submit">Adicionar Transportadora</button>
      </div>
    </form>

    <h3>Usuários Cadastrados</h3>
    <table class="table table-bordered">
      <thead>
        <tr>
          <th>Usuário</th>
          <th>Tipo</th>
          <th>Transportadora</th>
          <th>Ações</th>
        </tr>
      </thead>
      <tbody id="tabelaUsuarios"></tbody>
    </table>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="js/menu.js"></script>
  <script>
    const currentUser = JSON.parse(localStorage.getItem("usuarioLogado"));
    if (!currentUser || currentUser.tipo !== "admin") {
      Swal.fire("Acesso não autorizado!");
      window.location.href = "index.html";
    }

    const formUsuario = document.getElementById("formUsuario");
    const formTransportadora = document.getElementById("formTransportadora");
    const tabelaUsuarios = document.getElementById("tabelaUsuarios");
    const selectTransportadora = document.getElementById("selectTransportadora");
    const grupoTransportadora = document.getElementById("grupoTransportadora");
    const tipoUsuario = document.getElementById("tipoUsuario");

    let users = JSON.parse(localStorage.getItem("usuariosSistema") || "{}");
    let transportadoras = JSON.parse(localStorage.getItem("listaTransportadoras") || "[]");

    const padroes = ["Reunidas", "TJB", "Rede Sul", "Brasil Web", "Zanotelli", "Atual"];
    padroes.forEach(t => {
      if (!transportadoras.includes(t)) transportadoras.push(t);
    });
    localStorage.setItem("listaTransportadoras", JSON.stringify(transportadoras));

    tipoUsuario.addEventListener("change", () => {
      grupoTransportadora.classList.toggle("d-none", tipoUsuario.value !== "transportadora");
    });

    function atualizarTabela() {
      tabelaUsuarios.innerHTML = "";
      Object.entries(users).forEach(([usuario, dados]) => {
        const tr = document.createElement("tr");

        const tdUsuario = document.createElement("td");
        tdUsuario.textContent = usuario;
        tr.appendChild(tdUsuario);

        const tdTipo = document.createElement("td");
        tdTipo.textContent = dados.tipo;
        tr.appendChild(tdTipo);

        const tdTransportadora = document.createElement("td");
        tdTransportadora.textContent = dados.transportadora || "-";
        tr.appendChild(tdTransportadora);

        const tdAcoes = document.createElement("td");
        const botao = document.createElement("button");
        botao.textContent = "Excluir";
        botao.className = "btn btn-danger btn-sm";
        botao.onclick = () => {
          Swal.fire({
            title: 'Confirmação',
            text: `Excluir o usuário '${usuario}'?`,
            icon: 'question',
            showCancelButton: true,
            confirmButtonText: 'Sim',
            cancelButtonText: 'Não'
          }).then((result) => { 
            if (result.isConfirmed) {
              delete users[usuario];
              localStorage.setItem("usuariosSistema", JSON.stringify(users));
              atualizarTabela();
            }
          });
        };
        tdAcoes.appendChild(botao);
        tr.appendChild(tdAcoes);

        tabelaUsuarios.appendChild(tr);
      });
    }

    function atualizarSelectTransportadoras() {
      selectTransportadora.innerHTML = '<option value="">Selecione</option>';
      transportadoras.forEach(t => {
        const opt = document.createElement("option");
        opt.value = t;
        opt.textContent = t;
        selectTransportadora.appendChild(opt);
      });
    }

    formUsuario.addEventListener("submit", e => {
      e.preventDefault();
      const usuario = formUsuario.usuario.value.trim().toLowerCase();
      const senha = formUsuario.senha.value.trim();
      const tipo = formUsuario.tipo.value;
      const transportadora = tipo === "transportadora" ? formUsuario.transportadora.value.trim() : null;
      if (!usuario || !senha || !tipo) return;

      users[usuario] = {
        senha,
        tipo,
        transportadora
      };

      localStorage.setItem("usuariosSistema", JSON.stringify(users));
      formUsuario.reset();
      grupoTransportadora.classList.add("d-none");
      atualizarTabela();
    });

    formTransportadora.addEventListener("submit", e => {
      e.preventDefault();
      const nome = formTransportadora.nomeTransportadora.value.trim();
      if (!nome || transportadoras.includes(nome)) return;
      transportadoras.push(nome);
      localStorage.setItem("listaTransportadoras", JSON.stringify(transportadoras));
      atualizarSelectTransportadoras();
      formTransportadora.reset();
    });

    atualizarSelectTransportadoras();
    atualizarTabela();
  </script>
</body>
</html>
